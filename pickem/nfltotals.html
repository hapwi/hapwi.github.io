<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <link href="pickem.png" rel="shortcut icon" type="image/x-icon" />
    <title>NFL Pick'em totals</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.1/dist/css/bootstrap.min.css" rel="stylesheet"
        integrity="sha384-4bw+/aepP/YC94hEpVNVgiZdgIC5+VKNBQNGCHeKRQN+PtmoHDEXuppvnDJzQIu9" crossorigin="anonymous">
    <link href="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/css/select2.min.css" rel="stylesheet" />
    <link href="https://code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css" rel="stylesheet" />
    <link crossorigin="anonymous" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.1.0/css/all.min.css"
        rel="stylesheet" />
    <!-- ? link form styles -->
    <link rel="stylesheet" href="../styles/main.css">
    <!-- <link href="../styles/form.css" rel="stylesheet" /> -->
    <!-- jQuery and jQuery UI -->
    <!-- jQuery and jQuery UI -->
    <script src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css" rel="stylesheet">



    <!-- Select2 JS -->
    <script src="https://cdn.jsdelivr.net/npm/select2@4.0.13/dist/js/select2.min.js"></script>

    <!-- DataTables CSS -->
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.13.6/css/jquery.dataTables.css">

    <!-- DataTables JS -->
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.js">
    </script>

    <script src="./js/PEheader-footer.js"></script>
    <!-- ? main styles -->
    <style>
        html {
            scroll-behavior: smooth;
        }

        .table-wrapper {
            overflow-x: auto;
        }

        form {
            margin-bottom: 60px;
        }

        .team-link {
            color: inherit;
            text-decoration: none;
            display: block;
            padding: 8px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        table td {
            width: 50%;
            border-right: 1px solid #dee2e6;
            /* Line separating the columns */
        }

        table td:last-child {
            border-right: none;
        }

        .selected {
            background-color: #8ecc9c;
            color: #000000;
        }

        .card2 {
            color: #000000;
            text-align: left;
        }

        .container {
            margin-bottom: 70px;
        }

        .hidden-radio {
            position: absolute;
            opacity: 0;
            width: 0;
            height: 0;
        }

        .pt-custom {
            padding-top: 5rem !important;
            /* Adjust as needed */
            /* padding-bottom: 1rem !important; */
            /* Adjust as needed */
        }

        #myForm {
            margin-top: 2rem;
        }

        /* Navigation bar styles */
        #bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            /* height: 60px;
            background-color: var(--blue); */
            display: flex;
            justify-content: space-around;
            align-items: flex-start;
            /* Vertically align icons between middle and top */
            padding-top: 8px;
            /* Add top padding to adjust icon position */
            box-shadow: 0 -1px 5px rgba(0, 0, 0, 0.1);
            z-index: 9999;
        }

        #bottom-nav ul {
            display: flex;
            list-style: none;
            width: 100%;
            justify-content: space-around;
            padding: 0 20px;
            margin-top: 3px;
            /* Add this line to create space between <nav> and <ul> */
            background-color: var(--blue);
        }

        #bottom-nav li {
            text-align: center;
        }

        #bottom-nav a {
            display: block;
            padding: 8px;
            color: white;
            text-decoration: none;
        }

        header {
            background-color: var(--blue);
            color: white;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 60px;
            padding: 0;
            position: fixed;
            width: 100%;
            z-index: 9999;
        }

        .header-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            height: 100%;
        }

        .header-container {
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            /* needed to position the child #countdown-timer absolutely */
            width: 100%;
            height: 100%;
        }

        #countdown-timer {
            font-size: 18px;
            color: white;
            position: absolute;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            /* shift up by half of its own height to center */
        }

        .card {
            z-index: 1;
        }

        .logo {
            font-size: 24px;
            text-decoration: none;
            color: #fff;
            display: block;
            margin: auto;
        }





        #content {
            padding-top: 80px;
        }

        /* Media queries for responsive design */
        @media (max-width: 768px) {
            header {
                height: 50px;
            }

            .logo {
                font-size: 20px;
            }
        }

        #nflTable {
            margin-bottom: 30px;
            border-collapse: separate;
            border-radius: 15px;
            overflow: hidden;
            background-color: #f9f9f9;

        }

        #nflTable th {
            text-align: center;
            background: linear-gradient(to top, #204870, #003e7e);
            color: #fff;
            border-right: 2px solid #ccc;
        }

        #nflTable th:last-child {
            border-right: none;
        }


        #nflTable tbody tr:hover {
            background-color: #f2f2f2;
        }

        #nflTable td,
        #nflTable th {
            padding: 15px;
            border: 1px solid #dee2e6;
            text-align: center;


            /* Borders give a 3D, separated appearance to cells */
        }

        #picksTable th {
            text-align: center;
        }

        #picksTable td {
            text-align: center;
            vertical-align: middle;
            /* This will vertically center the content if there are multiple lines in a cell */
        }

        .card {
            margin-bottom: 30px;
            margin-top: 15px;
        }

        #noDataMessage {
            text-align: center;
            color: red;
        }

        #weekDropdown {
            padding: 5px 10px;
            font-size: 16px;
            border: 1px solid #ddd;
            border-radius: 5px;
            appearance: none;
            /* this removes default browser styling */
            -webkit-appearance: none;
            /* for Safari */
            -moz-appearance: none;
            /* for Firefox */
            background-color: #f9f9f9;
            color: #333;
            cursor: pointer;
            transition: border-color 0.3s;
        }

        #weekDropdown:hover {
            border-color: #999;
        }

        #picksTable tbody tr.matching-pick {
            background-color: lightgreen;
        }

        .dataTables_filter input {
            text-align: center;
        }

        .card {
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
            transition: box-shadow 0.3s;
        }

        .card:hover {
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
        }

        #pillNav2 {
            background-color: #003e7e;
            /* The color you provided */
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            z-index: 9999;
            color: transparent;
        }


        #pillNav2 .nav-item a.nav-link:hover,
        #pillNav2 .nav-item a.nav-link:focus {
            color: #003e7e;
            /* This sets the icon color on hover and focus to the blue you previously used */
            background-color: var(--bs-white);
            /* This sets the background color of the link on hover and focus to white */
        }

        #pillNav2 .nav-item a.nav-link.active {
            color: #003e7e;
            /* This sets the icon color for the active state to the blue you previously used */
            background-color: var(--bs-white);
            /* This sets the background color for the active state to white */
        }
    </style>
    <!-- ? end main styles -->
</head>

<body>
    <!-- ! header -->
    <header>
        <div class="header-container">
            <a class="logo">NFL Pick'em Totals</a>
            <div id="countdown-timer"></div>
            <a id="countdown-timer" href="../index.html"
                style="color:var(--link-white); text-decoration: none; margin-right:15px;">
                <i class="fa-solid fa-golf-ball-tee"></i>
            </a>


        </div>
    </header>
    <!-- ? main content -->
    <div class="container" style="padding-top: 70px;">
        <!-- Add this to your HTML -->


        <div class="card bg-light">

            <div class="card-body" id="table1">
                <p id="noDataMessage" style="display: none; color: red; text-align: center;">Pick history
                    is not available for
                    this week.</p>
                <table id="picksTable" class="display" style="width:100%">
                    <thead>
                        <tr>
                            <th></th>
                            <th></th>
                        </tr>
                    </thead>
                    <tbody id="picks"></tbody>

                </table>
            </div>

        </div>

        <div class="card bg-light">
            <div class="card-body" id="table2">
                <table id="nflTable" class="display" style="width:100%">
                    <thead>
                        <tr>
                            <th>Username</th>
                            <th>Total</th>
                        </tr>
                    </thead>
                    <tbody id="scores"></tbody>
                </table>
            </div>
        </div>
    </div>
    <!-- ? end of main content -->
    <!-- ! bottom nav -->
    <nav id="bottom-nav">
        <ul class="nav nav-pills nav-fill gap-2 p-1 medium shadow-sm" id="pillNav2" role="tablist"
            style="--bs-nav-link-color: var(--bs-white); --bs-nav-pills-link-active-color: var(--bs-primary); --bs-nav-pills-link-active-bg: var(--bs-white);">
            <li class="nav-item" role="presentation">
                <a href="#" id="menu-item-4" class="nav-link rounded-5">
                    <i class="bi bi-check-circle"></i>

                </a>
            </li>
            <li class="nav-item" role="presentation">
                <a href="nfltotals.html" id="menu-item-1" class="nav-link active rounded-5">
                    <i class="bi bi-list-task"></i>
                </a>
            </li>
        </ul>


    </nav>


    <script>
        const apiKey = 'AIzaSyCTIOtXB0RDa5Y5gubbRn328WIrqHwemrc';
        const spreadsheetId = '1iTNStqnadp4ZyR7MRkSmvX5WeialS4WST6Yy-Qv8Reo';
        let currentWeek = "1"; // Default week

        const winners = {
            "1": [], // Week 1
            "2": [], // Week 2
            "3": [], // Week 3
            "4": [], // Week 4
            "5": [], // Week 5
            "6": [], // Week 6
            "7": [], // Week 7
            "8": [], // Week 8
            "9": [], // Week 9
            "10": [], // Week 10
            "11": [], // Week 11
            "12": [], // Week 12
            "13": [], // Week 13
            "14": [], // Week 14
            "15": [], // Week 15
            "16": [], // Week 16
            "17": [], // Week 17
            "18": [], // Week 18
        };

        async function fetchNflScoresData() {
            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/nfl-scores!A1:R17?key=${apiKey}`
                );
                const data = await response.json();

                if (data.error) {
                    throw new Error(data.error.message);
                }

                if (data.values) {
                    processNflScoresData(data.values);
                } else {
                    console.log('No data found in the specified range.');
                }
            } catch (error) {
                console.error('Error fetching NFL Scores data:', error);
            }
        }

        function processNflScoresData(values) {
            // Assuming the first row contains week headers, which we'll skip
            const teams = values.slice(1);

            teams.forEach(teamRow => {
                teamRow.forEach((score, colIdx) => {
                    if (score && score.trim() !==
                        "") { // If there's a score (non-empty value) for that week
                        const week = (colIdx + 1).toString(); // Convert column index to week string
                        winners[week].push(teamRow[
                            0]); // Add the team name to the corresponding week in the winners object
                    }
                });
            });

            console.log('Updated winners object:', winners);
        }

        // Example usage
        fetchNflScoresData();


        async function fetchGoogleSheetsData() {
            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/nfl-totals!A1:B1000?key=${apiKey}`
                );
                const data = await response.json();
                console.log('Totals Data (nfl-totals):', data);


                if (data.error) {
                    throw new Error(data.error.message);
                }

                if (data.values) {
                    displayTable(data.values);
                } else {
                    console.log('No data found in the specified range.');
                }
            } catch (error) {
                console.error('Error fetching Google Sheets data:', error);
            }
        }

        function displayTable(rows) {
            const scoresTbody = document.getElementById('scores');

            rows.slice(1).forEach(row => {
                const [username, total] = row;
                const tableRow = `
            <tr>
                <td>${username}</td>
                <td>${total}</td>
            </tr>
        `;

                scoresTbody.innerHTML += tableRow;
            });

            $(document).ready(function () {
                $('#nflTable').DataTable({
                    searching: false,
                    lengthChange: false,
                    paging: false,
                    info: false,
                    ordering: false,

                });
            });
        }

        fetchGoogleSheetsData();

        async function fetchPicksData(week = 1) {
            const picksTbody = document.getElementById('picks');
            picksTbody.innerHTML = ''; // Clear the table before fetching new data

            try {
                const response = await fetch(
                    `https://sheets.googleapis.com/v4/spreadsheets/${spreadsheetId}/values/pemw${week}!A1:Q50?key=${apiKey}`
                );
                const data = await response.json();
                console.log(`Picks Data (pemw${week}):`, data);


                if (data.error) {
                    throw new Error(data.error.message);
                }

                // If the table is already initialized with DataTables, destroy it
                if ($.fn.dataTable.isDataTable('#picksTable')) {
                    $('#picksTable').DataTable().destroy();
                }

                const noDataMessage = document.getElementById('noDataMessage');

                if (data.values && data.values.length > 1) { // Assuming the first row is headers
                    displayPicksTable(data.values);
                    initDataTable();
                    noDataMessage.style.display = "none"; // Hide the no data message
                } else {
                    noDataMessage.style.display = "block"; // Show the no data message
                }
            } catch (error) {
                console.error('Error fetching Google Sheets data:', error);
                document.getElementById('noDataMessage').style.display =
                    "block"; // Show the no data message if there's an error
            }
        }




        function addControls() {
            $('<span class="search-label">Select a username to display picks history: </span>  \
        <select id="weekDropdown">\
        <option value="1" selected>Week 1</option>\
        <option value="2">Week 2</option>\
        <option value="3">Week 3</option>\
        <option value="4">Week 4</option>\
        <option value="5">Week 5</option>\
        <option value="6">Week 6</option>\
        <option value="7">Week 7</option>\
        <option value="8">Week 8</option>\
        <option value="9">Week 9</option>\
        <option value="10">Week 10</option>\
        <option value="11">Week 11</option>\
        <option value="12">Week 12</option>\
        <option value="13">Week 13</option>\
        <option value="14">Week 14</option>\
        <option value="15">Week 15</option>\
        <option value="16">Week 16</option>\
        <option value="17">Week 17</option>\
        <option value="18">Week 18</option>\
        </select>')
                .prependTo('#picksTable_filter');

            $('#picksTable_filter label').contents().filter(function () {
                return this.nodeType === 3;
            }).remove();

            document.getElementById('weekDropdown').value = currentWeek;

            // Dropdown change event
            document.getElementById('weekDropdown').addEventListener('change', function () {
                currentWeek = this.value;
                fetchPicksData(currentWeek);
                $('#picksTable_filter')
                    .show(); // Show the DataTables search control when a new week is selected
            });
        }

        let picksTable;

        $.fn.dataTable.ext.search.push(
            function (settings, data, dataIndex) {
                // Use the value of the search box
                let searchTerm = $('.dataTables_filter input').val();

                // Check if the search term matches the first column (username) exactly
                if (searchTerm === data[0]) {
                    return true;
                }
                return false;
            }
        );

        $(document).ready(function () {
            // Add a click event listener to each row of the nflTable
            $('#nflTable tbody').on('click', 'tr', function () {
                const noDataMessageVisible = document.getElementById('noDataMessage').style.display ===
                    "block";

                // Only proceed if the no data message isn't displayed
                if (!noDataMessageVisible) {
                    // Get the username from the first cell of the clicked row
                    let username = $(this).find('td:first').text();

                    // Set this username as the value for the picksTable DataTables search input
                    $('#picksTable_filter input').val(username);

                    // Trigger a search on the picksTable
                    $('#picksTable').DataTable().search(username).draw();

                    // Use the native CSS scrolling
                    window.scrollTo({
                        top: 0,
                        behavior: 'smooth'
                    });
                }
            });
        });




        function initDataTable() {
            if (!$.fn.dataTable.isDataTable('#picksTable')) {
                picksTable = $('#picksTable').DataTable({
                    searching: true,
                    searchCols: [{
                        searchable: true
                    }, {
                        searchable: false
                    }],
                    search: {
                        smart: false
                    },
                    lengthChange: false,
                    paging: false,
                    info: false,
                    ordering: false,
                    columnDefs: [{
                        targets: 0, // Hide the first column
                        visible: false,
                        searchable: true
                    }],
                    drawCallback: function () {
                        var table = $('#picksTable').DataTable();
                        if (table.search() !== "") {
                            $('#picks').show();
                        } else {
                            $('#picks').hide();
                        }
                    }
                });
                addControls();
                $('#picksTable_filter input').prop('readonly', true);
            }
        }

        function highlightMatchingPicks() {
            const picksTable = document.getElementById('picksTable');
            const rows = picksTable.querySelectorAll('tbody tr');
            const weekWinners = winners[currentWeek] || [];

            console.log("Current Week:", currentWeek); // Log the current week
            console.log("Week's Winners:", weekWinners); // Log the winners for the week

            rows.forEach(row => {
                const pickCell = row.querySelector('td:nth-child(2)');
                const pick = pickCell.textContent.trim();

                console.log('Checking Pick:', pick); // Log the pick being checked

                if (weekWinners.excludes(pick)) {
                    console.log('Highlighting Pick:', pick); // Log when a match is found
                    row.classList.add('matching-pick');
                }
            });
        }

        function displayPicksTable(rows) {
            const picksTbody = document.getElementById('picks');
            picksTbody.innerHTML = ''; // Clear the previous data
            const weekWinners = winners[currentWeek] || []; // get winners for the selected week

            rows.slice(1).forEach(row => {
                const username = row[0];
                const picks = row.slice(1);

                // Loop through each pick and create a new row
                picks.forEach(pick => {
                    let isMatchingPick = weekWinners.includes(
                        pick); // Check if pick matches the winners
                    const tableRow = `
                <tr class="${isMatchingPick ? 'matching-pick' : ''}">
                    <td>${username}</td>
                    <td>${pick}</td>
                </tr>
            `;

                    picksTbody.innerHTML += tableRow;
                });
            });

            // If the table is already initialized, destroy it
            if ($.fn.dataTable.isDataTable('#picksTable')) {
                $('#picksTable').DataTable().destroy();
            }
            highlightMatchingPicks();
            initDataTable();
        }

        function highlightMatchingPicks() {
            const picksTable = document.getElementById('picksTable');
            const rows = picksTable.querySelectorAll('tbody tr');
            const weekWinners = winners[currentWeek] || [];

            console.log("Current Week:", currentWeek); // Log the current week
            console.log("Week's Winners:", weekWinners); // Log the winners for the week

            rows.forEach(row => {
                const pickCell = row.querySelector('td:nth-child(2)');
                const pick = pickCell.textContent.trim();

                console.log('Checking Pick:', pick); // Log the pick being checked

                if (weekWinners.includes(pick)) {
                    console.log('Highlighting Pick:', pick); // Log when a match is found
                    row.classList.add('matching-pick');
                }
            });
        }

        fetchPicksData();
    </script>

    <script>
        // Define the deadlines for each week
        var weeks = [{
                start: new Date("08/03/23 08:35 AM MST"), // Preweek start date
                end: new Date("09/04/23 8:30 AM MST") // Preweek end date
            }, // Preweek
            {
                start: new Date("09/04/23 08:35 AM MST"),
                end: new Date("09/07/23 05:20 PM MST")
            }, // Week 1
            {
                start: new Date("09/11/23 05:15 PM MST"),
                end: new Date("09/14/23 05:15 PM MST")
            }, // Week 2
            {
                start: new Date("09/18/23 04:15 PM MST"),
                end: new Date("09/21/23 05:15 PM MST")
            }, // Week 3
            {
                start: new Date("09/25/23 04:15 PM MST"),
                end: new Date("09/28/23 05:15 PM MST")
            }, // Week 4
            {
                start: new Date("10/02/23 05:15 PM MST"),
                end: new Date("10/05/23 05:15 PM MST")
            }, // Week 5
            {
                start: new Date("10/09/23 05:15 PM MST"),
                end: new Date("10/11/23 05:15 PM MST")
            }, // Week 6
            {
                start: new Date("10/16/23 05:15 PM MST"),
                end: new Date("10/19/23 05:15 PM MST")
            }, // Week 7
            {
                start: new Date("10/23/23 05:15 PM MST"),
                end: new Date("10/26/23 05:15 PM MST")
            }, // Week 8
            {
                start: new Date("10/30/23 05:15 PM MST"),
                end: new Date("11/02/23 05:15 PM MST")
            }, // Week 9
            {
                start: new Date("11/06/23 06:15 PM MST"),
                end: new Date("11/09/23 06:15 PM MST")
            }, // Week 10
            {
                start: new Date("11/13/23 06:15 PM MST"),
                end: new Date("11/16/23 06:15 PM MST")
            }, // Week 11
            {
                start: new Date("11/20/23 06:15 PM MST"),
                end: new Date("11/23/23 10:30 AM MST")
            }, // Week 12
            {
                start: new Date("11/27/23 06:15 PM MST"),
                end: new Date("11/30/23 06:15 PM MST")
            }, // Week 13
            {
                start: new Date("12/04/23 06:15 PM MST"),
                end: new Date("12/07/23 06:15 PM MST")
            }, // Week 14
            {
                start: new Date("12/11/23 06:15 PM MST"),
                end: new Date("12/14/23 06:15 PM MST")
            }, // Week 15
            {
                start: new Date("12/18/23 06:15 PM MST"),
                end: new Date("12/21/23 06:15 PM MST")
            }, // Week 16
            {
                start: new Date("12/25/23 11:00 AM MST"),
                end: new Date("12/28/24 06:15 PM MST")
            }, // Week 17
            {
                start: new Date("12/31/24 11:00 AM MST"),
                end: new Date("01/07/24 08:35 AM MST") //change this when times are announced
            } // Week 18
        ];

        document.addEventListener('DOMContentLoaded', function () {
            // Define the current date and time
            var now = new Date();

            // Your existing code
            var currentWeek = 0;
            for (var i = 0; i < weeks.length; i++) {
                if (now.getTime() >= weeks[i].start.getTime() && now.getTime() <= weeks[i].end.getTime()) {
                    currentWeek = i;
                    break;
                }
            }

            // Get the anchor element for menu item 4
            var menuItem4 = document.getElementById('menu-item-4');

            // If the current time is within the preweek date range, handle the preweek case
            if (currentWeek === 0) {
                menuItem4.href = 'preweek.html'; // Update the href to the preweek page
            } else if (currentWeek > 0) {
                menuItem4.href = 'week' + currentWeek +
                    '.html'; // Update the href to the corresponding week's page
            } else {
                menuItem4.href = 'week' + currentWeek +
                    '.html'; // Update the href to the corresponding week's page if necessary
            }
        });
    </script>
</body>

</html>